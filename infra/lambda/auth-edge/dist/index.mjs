var se=Object.defineProperty;var Be=Object.getOwnPropertyDescriptor;var We=Object.getOwnPropertyNames;var Ae=Object.prototype.hasOwnProperty;var Oe=(t,e)=>{for(var r in e)se(t,r,{get:e[r],enumerable:!0})},Re=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of We(e))!Ae.call(t,n)&&n!==r&&se(t,n,{get:()=>e[n],enumerable:!(s=Be(e,n))||s.enumerable});return t};var je=t=>Re(se({},"__esModule",{value:!0}),t);var rt={};Oe(rt,{handler:()=>tt});module.exports=je(rt);var l=class extends Error{},p=class extends l{constructor(e,r,s){super(e),this.failedAssertion={actual:r,expected:s}}},a=class extends l{constructor(e,r){let s=r!=null?`${e}: ${r}`:e;super(s)}},u=class extends l{},R=class extends l{},j=class extends p{},d=class extends p{withRawJwt({header:e,payload:r}){return this.rawJwt={header:e,payload:r},this}},K=class extends d{},_=class extends d{},M=class extends d{},q=class extends d{},H=class extends d{},V=class extends d{},U=class extends d{},P=class extends d{};var x=class extends l{},m=class extends l{},T=class extends l{},b=class extends l{},L=class extends l{},z=class extends l{},G=class extends p{},Z=class extends p{},g=class extends l{constructor(e,r){super(`Failed to fetch ${e}: ${r}`)}},J=class extends g{};var B=require("crypto");var S;(function(t){t[t.Universal=0]="Universal"})(S||(S={}));var v;(function(t){t[t.Primitive=0]="Primitive",t[t.Constructed=1]="Constructed"})(v||(v={}));var I;(function(t){t[t.BitString=3]="BitString",t[t.ObjectIdentifier=6]="ObjectIdentifier",t[t.Sequence=16]="Sequence",t[t.Null=5]="Null",t[t.Integer=2]="Integer"})(I||(I={}));function E(t){let e=t.class<<7|t.primitiveOrConstructed<<5|t.tag;return Buffer.from([e])}function F(t){if(t<128)return Buffer.from([t]);let e=[];for(;t>0;)e.push(t%256),t=t>>8;return e.reverse(),Buffer.from([128|e.length,...e])}function he(t){return t[0]>>7&&(t=Buffer.concat([Buffer.from([0]),t])),Buffer.concat([E({class:S.Universal,primitiveOrConstructed:v.Primitive,tag:I.Integer}),F(t.length),t])}function Ue(t){let e=t.split(".").map(i=>parseInt(i)),r=e[0]*40+e[1],s=e.slice(2).reduce((i,o)=>{let f=[];do f.push(o%128),o=o>>7;while(o);return i.concat(f.map((c,h)=>h?c+128:c).reverse())},[]),n=Buffer.from([r,...s]);return Buffer.concat([E({class:S.Universal,primitiveOrConstructed:v.Primitive,tag:I.ObjectIdentifier}),F(n.length),n])}function Pe(t){let e=Buffer.concat([Buffer.from([0]),t]);return Buffer.concat([E({class:S.Universal,primitiveOrConstructed:v.Primitive,tag:I.BitString}),F(e.length),e])}function ne(t){let e=Buffer.concat(t);return Buffer.concat([E({class:S.Universal,primitiveOrConstructed:v.Constructed,tag:I.Sequence}),F(e.length),e])}function Ee(){return Buffer.concat([E({class:S.Universal,primitiveOrConstructed:v.Primitive,tag:I.Null}),F(0)])}var Fe=ne([Ue("1.2.840.113549.1.1.1"),Ee()]);function ie(t,e){return ne([Fe,Pe(ne([he(t),he(e)]))])}var le=require("https");function we(t,e,r){if(e===429)throw new g(t,"Too many requests");if(e!==200)throw new J(t,`Status code is ${e}, expected 200`);if(!r||!r.toLowerCase().startsWith("application/json"))throw new J(t,`Content-type is "${r}", expected "application/json"`)}var pe=require("stream"),ye=require("util");function $(t){return typeof t=="object"&&!Array.isArray(t)&&t!==null}function D(t){return JSON.parse(t,(e,r)=>(typeof r=="object"&&!Array.isArray(r)&&r!==null&&(delete r.__proto__,delete r.constructor),r))}async function me(t,e,r){let s;return new Promise((n,i)=>{let o=(0,le.request)(t,{method:"GET",...e},c=>{(0,pe.pipeline)([c,De(t,c.statusCode,c.headers)],f)});e?.responseTimeout&&(s=setTimeout(()=>f(new g(t,`Response time-out (after ${e.responseTimeout} ms.)`)),e.responseTimeout),s.unref());function f(...c){if(s&&clearTimeout(s),c[0]==null){n(c[1]);return}o.socket?.emit("agentRemove");let h=c[0];h instanceof g||(h=new g(t,h.message)),o.destroy(),i(h)}o.on("error",f),o.end(r)})}function De(t,e,r){return async s=>{we(t,e,r["content-type"]);let n=[];for await(let i of s)n.push(i);try{return D(new ye.TextDecoder("utf8",{fatal:!0,ignoreBOM:!0}).decode(Buffer.concat(n)))}catch(i){throw new J(t,i)}}}var Y;(function(t){t.RS256="RSA-SHA256",t.RS384="RSA-SHA384",t.RS512="RSA-SHA512"})(Y||(Y={}));var w={fetchJson:me,transformJwkToKeyObjectSync:t=>(0,B.createPublicKey)({key:ie(Buffer.from(t.n,"base64"),Buffer.from(t.e,"base64")),format:"der",type:"spki"}),transformJwkToKeyObjectAsync:async t=>(0,B.createPublicKey)({key:ie(Buffer.from(t.n,"base64"),Buffer.from(t.e,"base64")),format:"der",type:"spki"}),parseB64UrlString:t=>Buffer.from(t,"base64").toString("utf8"),verifySignatureSync:({alg:t,keyObject:e,jwsSigningInput:r,signature:s})=>(0,B.createVerify)(Y[t]).update(r).verify(e,s,"base64"),verifySignatureAsync:async({alg:t,keyObject:e,jwsSigningInput:r,signature:s})=>(0,B.createVerify)(Y[t]).update(r).verify(e,s,"base64"),defaultFetchTimeouts:{socketIdle:500,response:1500},setTimeoutUnref:(...t)=>setTimeout(...t).unref()};var Q=w.fetchJson,X=class{constructor(e){this.defaultRequestOptions={timeout:w.defaultFetchTimeouts.socketIdle,responseTimeout:w.defaultFetchTimeouts.response,...e?.defaultRequestOptions}}async fetch(e,r,s){r={...this.defaultRequestOptions,...r};try{return await Q(e,r,s)}catch(n){if(n instanceof J)throw n;return Q(e,r,s)}}};function C(t,e,r,s=p){if(!e)throw new s(`Missing ${t}. Expected: ${r}`,e,r);if(typeof e!="string")throw new s(`${t} is not of type string`,e,r);if(r!==e)throw new s(`${t} not allowed: ${e}. Expected: ${r}`,e,r)}function k(t,e,r,s=p){if(!e)throw new s(`Missing ${t}. ${oe(r)}`,e,r);if(typeof e!="string")throw new s(`${t} is not of type string`,e,r);return W(t,e,r,s)}function W(t,e,r,s=p){if(!e)throw new s(`Missing ${t}. ${oe(r)}`,e,r);let n=new Set(Array.isArray(r)?r:[r]);if(typeof e=="string"&&(e=[e]),!Array.isArray(e))throw new s(`${t} is not an array`,e,r);if(!e.some(o=>{if(typeof o!="string")throw new s(`${t} includes elements that are not of type string`,e,r);return n.has(o)}))throw new s(`${t} not allowed: ${e.join(", ")}. ${oe(r)}`,e,r)}function oe(t){return Array.isArray(t)?t.length>1?`Expected one of: ${t.join(", ")}`:`Expected: ${t[0]}`:`Expected: ${t}`}function ge(t,e){if(t&&typeof t.then=="function")throw e()}var Ne=["use","alg","kid","n","e"],_e=["kty"];function A(t,e){return t.keys.find(r=>r.kid!=null&&r.kid===e)}async function Me(t){let e=await Q(t);return ce(e),e}async function Je(t,e){if(!e.header.kid)throw new T("JWT header does not have valid kid claim");let r=await Me(t),s=A(r,e.header.kid);if(!s)throw new b(`JWK for kid "${e.header.kid}" not found in the JWKS`);return s}function ce(t){if(!t)throw new x("JWKS empty");if(!$(t))throw new x("JWKS should be an object");if(!Object.keys(t).includes("keys"))throw new x("JWKS does not include keys");if(!Array.isArray(t.keys))throw new x("JWKS keys should be an array");for(let e of t.keys)be(e)}function ke(t){if(C("JWK use",t.use,"sig",G),C("JWK kty",t.kty,"RSA",Z),!t.n)throw new m("Missing modulus (n)");if(!t.e)throw new m("Missing exponent (e)")}function be(t){if(!t)throw new m("JWK empty");if(!$(t))throw new m("JWK should be an object");for(let e of _e)if(typeof t[e]!="string")throw new m(`JWK ${e} should be a string`);for(let e of Ne)if(e in t&&typeof t[e]!="string")throw new m(`JWK ${e} should be a string`)}function xe(t){try{return ce(t),!0}catch{return!1}}function Se(t){try{return be(t),!0}catch{return!1}}var ae=class{constructor(e){this.waitingUris=new Map,this.waitSeconds=e?.waitSeconds??10}async wait(e){if(this.waitingUris.has(e))throw new L("Not allowed to fetch JWKS yet, still waiting for back off period to end")}release(e){let r=this.waitingUris.get(e);r&&(clearTimeout(r),this.waitingUris.delete(e))}registerFailedAttempt(e){let r=w.setTimeoutUnref(()=>{this.waitingUris.delete(e)},this.waitSeconds*1e3);this.waitingUris.set(e,r)}registerSuccessfulAttempt(e){this.release(e)}},ee=class{constructor(e){this.jwksCache=new Map,this.fetchingJwks=new Map,this.penaltyBox=e?.penaltyBox??new ae,this.fetcher=e?.fetcher??new X}addJwks(e,r){this.jwksCache.set(e,r)}async getJwks(e){let r=this.fetchingJwks.get(e);if(r)return r;let s=this.fetcher.fetch(e).then(i=>(ce(i),i));this.fetchingJwks.set(e,s);let n;try{n=await s}finally{this.fetchingJwks.delete(e)}return this.jwksCache.set(e,n),n}getCachedJwk(e,r){if(typeof r.header.kid!="string")throw new T("JWT header does not have valid kid claim");if(!this.jwksCache.has(e))throw new z(`JWKS for uri ${e} not yet available in cache`);let s=A(this.jwksCache.get(e),r.header.kid);if(!s)throw new b(`JWK for kid ${r.header.kid} not found in the JWKS`);return s}async getJwk(e,r){if(typeof r.header.kid!="string")throw new T("JWT header does not have valid kid claim");let s=this.jwksCache.get(e);if(s){let o=A(s,r.header.kid);if(o)return o}await this.penaltyBox.wait(e,r.header.kid);let n=await this.getJwks(e),i=A(n,r.header.kid);if(i)this.penaltyBox.registerSuccessfulAttempt(e,r.header.kid);else throw this.penaltyBox.registerFailedAttempt(e,r.header.kid),new b(`JWK for kid "${r.header.kid}" not found in the JWKS`);return i}};var ve=["RS256","RS384","RS512"];function qe(t){if(!$(t))throw new a("JWT header is not an object");if(t.alg!==void 0&&typeof t.alg!="string")throw new a("JWT header alg claim is not a string");if(t.kid!==void 0&&typeof t.kid!="string")throw new a("JWT header kid claim is not a string")}function He(t){if(!$(t))throw new a("JWT payload is not an object");if(t.exp!==void 0&&!Number.isFinite(t.exp))throw new a("JWT payload exp claim is not a number");if(t.iss!==void 0&&typeof t.iss!="string")throw new a("JWT payload iss claim is not a string");if(t.sub!==void 0&&typeof t.sub!="string")throw new a("JWT payload sub claim is not a string");if(t.aud!==void 0&&typeof t.aud!="string"&&(!Array.isArray(t.aud)||t.aud.some(e=>typeof e!="string")))throw new a("JWT payload aud claim is not a string or array of strings");if(t.nbf!==void 0&&!Number.isFinite(t.nbf))throw new a("JWT payload nbf claim is not a number");if(t.iat!==void 0&&!Number.isFinite(t.iat))throw new a("JWT payload iat claim is not a number");if(t.scope!==void 0&&typeof t.scope!="string")throw new a("JWT payload scope claim is not a string");if(t.jti!==void 0&&typeof t.jti!="string")throw new a("JWT payload jti claim is not a string")}function Ie(t){if(!t)throw new a("Empty JWT");if(typeof t!="string")throw new a("JWT is not a string");if(!t.match(/^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$/))throw new a("JWT string does not consist of exactly 3 parts (header, payload, signature)");let[e,r,s]=t.split("."),[n,i]=[e,r].map(w.parseB64UrlString),o;try{o=D(n)}catch(c){throw new a("Invalid JWT. Header is not a valid JSON object",c)}qe(o);let f;try{f=D(i)}catch(c){throw new a("Invalid JWT. Payload is not a valid JSON object",c)}return He(f),{header:o,headerB64:e,payload:f,payloadB64:r,signatureB64:s}}function fe(t,e){if(t.exp!==void 0&&t.exp+(e.graceSeconds??0)<Date.now()/1e3)throw new q(`Token expired at ${new Date(t.exp*1e3).toISOString()}`,t.exp);if(t.nbf!==void 0&&t.nbf-(e.graceSeconds??0)>Date.now()/1e3)throw new H(`Token can't be used before ${new Date(t.nbf*1e3).toISOString()}`,t.nbf);if(e.issuer!==null){if(e.issuer===void 0)throw new u("issuer must be provided or set to null explicitly");k("Issuer",t.iss,e.issuer,K)}if(e.audience!==null){if(e.audience===void 0)throw new u("audience must be provided or set to null explicitly");W("Audience",t.aud,e.audience,_)}e.scope!=null&&W("Scope",t.scope?.split(" "),e.scope,M)}function Ce(t,e){ke(e),e.alg&&C("JWT signature algorithm",t.alg,e.alg,j),k("JWT signature algorithm",t.alg,ve,j)}async function Ve(t,e,r,s=Je,n=w.transformJwkToKeyObjectAsync){let{header:i,headerB64:o,payload:f,payloadB64:c,signatureB64:h}=t,O=await s(e,t);Ce(t.header,O);let de=await n(O,i.alg,f.iss);if(!await w.verifySignatureAsync({jwsSigningInput:`${o}.${c}`,signature:h,alg:i.alg,keyObject:de}))throw new R("Invalid signature");try{fe(f,r),r.customJwtCheck&&await r.customJwtCheck({header:i,payload:f,jwk:O})}catch(re){throw r.includeRawJwtInErrors&&re instanceof d?re.withRawJwt(t):re}return f}function Le(t,e,r,s){let{header:n,headerB64:i,payload:o,payloadB64:f,signatureB64:c}=t,h;if(Se(e))h=e;else if(xe(e)){let y=n.kid?A(e,n.kid):void 0;if(!y)throw new b(`JWK for kid ${n.kid} not found in the JWKS`);h=y}else throw new u([`Expected a valid JWK or JWKS (parsed as JavaScript object), but received: ${e}.`,"If you're passing a JWKS URI, use the async verify() method instead, it will download and parse the JWKS for you"].join());Ce(t.header,h);let O=s(h,n.alg,o.iss);if(!w.verifySignatureSync({jwsSigningInput:`${i}.${f}`,signature:c,alg:n.alg,keyObject:O}))throw new R("Invalid signature");try{if(fe(o,r),r.customJwtCheck){let y=r.customJwtCheck({header:n,payload:o,jwk:h});ge(y,()=>new u("Custom JWT checks must be synchronous but a promise was returned"))}}catch(y){throw r.includeRawJwtInErrors&&y instanceof d?y.withRawJwt(t):y}return o}var te=class{constructor(e,r=new ee){if(this.jwksCache=r,this.issuersConfig=new Map,this.publicKeyCache=new ue,Array.isArray(e)){if(!e.length)throw new u("Provide at least one issuer configuration");for(let s of e){if(this.issuersConfig.has(s.issuer))throw new u(`issuer ${s.issuer} supplied multiple times`);this.issuersConfig.set(s.issuer,this.withJwksUri(s))}}else this.issuersConfig.set(e.issuer,this.withJwksUri(e))}get expectedIssuers(){return Array.from(this.issuersConfig.keys())}getIssuerConfig(e){if(!e){if(this.issuersConfig.size!==1)throw new u("issuer must be provided");e=this.issuersConfig.keys().next().value}let r=this.issuersConfig.get(e);if(!r)throw new u(`issuer not configured: ${e}`);return r}cacheJwks(...[e,r]){let s=this.getIssuerConfig(r);this.jwksCache.addJwks(s.jwksUri,e),this.publicKeyCache.clearCache(s.issuer)}async hydrate(){let e=this.expectedIssuers.map(r=>this.getIssuerConfig(r).jwksUri).map(r=>this.jwksCache.getJwks(r));await Promise.all(e)}verifySync(...[e,r]){let{decomposedJwt:s,jwksUri:n,verifyProperties:i}=this.getVerifyParameters(e,r);return this.verifyDecomposedJwtSync(s,n,i)}verifyDecomposedJwtSync(e,r,s){let n=this.jwksCache.getCachedJwk(r,e);return Le(e,n,s,this.publicKeyCache.transformJwkToKeyObjectSync.bind(this.publicKeyCache))}async verify(...[e,r]){let{decomposedJwt:s,jwksUri:n,verifyProperties:i}=this.getVerifyParameters(e,r);return this.verifyDecomposedJwt(s,n,i)}verifyDecomposedJwt(e,r,s){return Ve(e,r,s,this.jwksCache.getJwk.bind(this.jwksCache),this.publicKeyCache.transformJwkToKeyObjectAsync.bind(this.publicKeyCache))}getVerifyParameters(e,r){let s=Ie(e);k("Issuer",s.payload.iss,this.expectedIssuers,K);let n=this.getIssuerConfig(s.payload.iss);return{decomposedJwt:s,jwksUri:n.jwksUri,verifyProperties:{...n,...r}}}withJwksUri(e){if(e.jwksUri)return e;let r=new URL(e.issuer).pathname.replace(/\/$/,"");return{jwksUri:new URL(`${r}/.well-known/jwks.json`,e.issuer).href,...e}}};var ue=class{constructor(e=w.transformJwkToKeyObjectSync,r=w.transformJwkToKeyObjectAsync){this.transformJwkToKeyObjectSyncFn=e,this.transformJwkToKeyObjectAsyncFn=r,this.publicKeys=new Map}transformJwkToKeyObjectSync(e,r,s){let n=e.alg??r;if(!s||!e.kid||!n)return this.transformJwkToKeyObjectSyncFn(e,n,s);let i=this.publicKeys.get(s)?.get(e.kid)?.get(n);if(i)return i;let o=this.transformJwkToKeyObjectSyncFn(e,n,s);return this.putKeyObjectInCache(s,e.kid,n,o),o}async transformJwkToKeyObjectAsync(e,r,s){let n=e.alg??r;if(!s||!e.kid||!n)return this.transformJwkToKeyObjectAsyncFn(e,n,s);let i=this.publicKeys.get(s)?.get(e.kid)?.get(n);if(i)return i;let o=await this.transformJwkToKeyObjectAsyncFn(e,n,s);return this.putKeyObjectInCache(s,e.kid,n,o),o}putKeyObjectInCache(e,r,s,n){let i=this.publicKeys.get(e),o=i?.get(r);o?o.set(s,n):i?i.set(r,new Map([[s,n]])):this.publicKeys.set(e,new Map([[r,new Map([[s,n]])]]))}clearCache(e){this.publicKeys.delete(e)}};function Ke(t,e){if(e.groups!=null&&W("Cognito group",t["cognito:groups"],e.groups,V),k("Token use",t.token_use,["id","access"],U),e.tokenUse!==null){if(e.tokenUse===void 0)throw new u("tokenUse must be provided or set to null explicitly");C("Token use",t.token_use,e.tokenUse,U)}if(e.clientId!==null){if(e.clientId===void 0)throw new u("clientId must be provided or set to null explicitly");t.token_use==="id"?k('Client ID ("audience")',t.aud,e.clientId,P):k("Client ID",t.client_id,e.clientId,P)}}var N=class t extends te{constructor(e,r){let s=Array.isArray(e)?e.map(n=>({...n,...t.parseUserPoolId(n.userPoolId),audience:null})):{...e,...t.parseUserPoolId(e.userPoolId),audience:null};super(s,r)}static parseUserPoolId(e){let r=e.match(/^(?<region>(\w+-)?\w+-\w+-\d)+_\w+$/);if(!r)throw new u(`Invalid Cognito User Pool ID: ${e}`);let n=`https://cognito-idp.${r.groups.region}.amazonaws.com/${e}`;return{issuer:n,jwksUri:`${n}/.well-known/jwks.json`}}static create(e,r){return new this(e,r?.jwksCache)}verifySync(...[e,r]){let{decomposedJwt:s,jwksUri:n,verifyProperties:i}=this.getVerifyParameters(e,r);this.verifyDecomposedJwtSync(s,n,i);try{Ke(s.payload,i)}catch(o){throw i.includeRawJwtInErrors&&o instanceof d?o.withRawJwt(s):o}return s.payload}async verify(...[e,r]){let{decomposedJwt:s,jwksUri:n,verifyProperties:i}=this.getVerifyParameters(e,r);await this.verifyDecomposedJwt(s,n,i);try{Ke(s.payload,i)}catch(o){throw i.includeRawJwtInErrors&&o instanceof d?o.withRawJwt(s):o}return s.payload}cacheJwks(...[e,r]){let s;if(r!==void 0)s=t.parseUserPoolId(r).issuer;else if(this.expectedIssuers.length>1)throw new u("userPoolId must be provided");let n=this.getIssuerConfig(s);super.cacheJwks(e,n.issuer)}};var ze="us-east-1",Ge="us-east-1_PApw7t541",$e="6evgd9kupcn26vc5nmtuajqrkm",Ze=`https://us-east-1papw7t541.auth.${ze}.amazoncognito.com`,Ye="https://d1cssc0skay50s.cloudfront.net/pages/callback.html",Qe=new Set(["/pages/app.html"]),Xe=N.create({userPoolId:Ge,tokenUse:"id",clientId:$e});function et(t,e){let r=t?.cookie?.[0]?.value??"",s=new RegExp(`(?:^|;\\s*)${e}=([^;]+)`),n=r.match(s);return n&&n[1]}function Te(){return{status:"302",statusDescription:"Found",headers:{location:[{key:"Location",value:`${Ze}/login?client_id=${$e}&response_type=code&scope=openid+profile&redirect_uri=${encodeURIComponent(Ye)}`}],"cache-control":[{key:"Cache-Control",value:"no-store"}]}}}var tt=async t=>{let e=t.Records[0].cf.request,r=e.uri;if(!Qe.has(r))return e;let s=et(e.headers,"id_token");if(!s)return Te();try{return await Xe.verify(s),e}catch{return Te()}};0&&(module.exports={handler});
